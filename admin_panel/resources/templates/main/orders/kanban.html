{% extends 'common/home.html' %}
{% load static %}

<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

{% block content %}
<link rel="stylesheet" href="{% static 'css/kanban.css' %}">

<h1 class="my-4">Orders</h1>

<div class="kanban-board">
    <!-- New Orders Column -->
    <div class="kanban-column">
        <h2 class="bg-primary">New</h2>
        <div id="new-orders" class="kanban-items" data-status="new">
            {% for order in orders_by_status.new %}
            <div class="kanban-item" data-id="{{ order.id }}">
                <p><strong>ID:</strong> {{ order.id }}</p>
                <p><strong>Client:</strong> {{ order.client.name }}</p>
                <p><strong>Amount:</strong> {{ order.amount }} $</p>
                <p><strong>Time:</strong> {{ order.created_date|date:"H:i" }}</p>
                <a href="{% url 'edit_order' order.id %}" class="btn btn-outline-light" style="color: inherit; border-color: inherit;">Edit Order</a>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- In Process Orders Column -->
    <div class="kanban-column">
        <h2 class="bg-warning">In Process</h2>
        <div id="in-process-orders" class="kanban-items" data-status="in_process">
            {% for order in orders_by_status.in_process %}
            <div class="kanban-item" data-id="{{ order.id }}">
                <p><strong>ID:</strong> {{ order.id }}</p>
                <p><strong>Client:</strong> {{ order.client.name }}</p>
                <p><strong>Amount:</strong> {{ order.amount }} $</p>
                <p><strong>Time:</strong> {{ order.created_date|date:"H:i" }}</p>
                <a href="{% url 'edit_order' order.id %}" class="btn btn-outline-light" style="color: inherit; border-color: inherit;">Edit Order</a>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Sent Orders Column -->
    <div class="kanban-column">
        <h2 class="bg-info">Sent</h2>
        <div id="sent-orders" class="kanban-items" data-status="sent">
            {% for order in orders_by_status.sent %}
            <div class="kanban-item" data-id="{{ order.id }}">
                <p><strong>ID:</strong> {{ order.id }}</p>
                <p><strong>Client:</strong> {{ order.client.name }}</p>
                <p><strong>Amount:</strong> {{ order.amount }} $</p>
                <p><strong>Time:</strong> {{ order.created_date|date:"H:i" }}</p>
                <a href="{% url 'edit_order' order.id %}" class="btn btn-outline-light" style="color: inherit; border-color: inherit;">Edit Order</a>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Delivered Orders Column -->
    <div class="kanban-column">
        <h2 class="bg-success">Delivered</h2>
        <div id="delivered-orders" class="kanban-items" data-status="delivered">
            {% for order in orders_by_status.delivered %}
            <div class="kanban-item" data-id="{{ order.id }}">
                <p><strong>ID:</strong> {{ order.id }}</p>
                <p><strong>Client:</strong> {{ order.client.name }}</p>
                <p><strong>Amount:</strong> {{ order.amount }} $</p>
                <p><strong>Time:</strong> {{ order.created_date|date:"H:i" }}</p>
                <a href="{% url 'edit_order' order.id %}" class="btn btn-outline-light" style="color: inherit; border-color: inherit;">Edit Order</a>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Status Change Confirmation Modal -->
<div class="modal fade" id="statusModal" tabindex="-1" role="dialog" aria-labelledby="statusModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="statusModalLabel">Confirm Status Change</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Are you sure you want to change the status of this order?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmStatusChange">Change Status</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
<script>
    let orderIdToUpdate = null;
    let newStatusToUpdate = null;

    document.querySelectorAll('.kanban-items').forEach(function (column) {
        new Sortable(column, {
            group: 'orders',
            animation: 150,
            emptyInsertThreshold: 25,
            onEnd: function (evt) {
                orderIdToUpdate = evt.item.dataset.id;
                newStatusToUpdate = evt.to.dataset.status;
                $('#statusModal').modal('show');
            }
        });
    });

    document.getElementById('confirmStatusChange').addEventListener('click', async function () {
        try {
            const response = await fetch(`/orders/update_status/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ id: orderIdToUpdate, status: newStatusToUpdate })
            });

            if (!response.ok) {
                alert('Error updating order status. The operation was not saved.');
                location.reload();
            } else {
                $('#statusModal').modal('hide');
            }
        } catch (error) {
            console.error('Error updating status:', error);
            alert('Connection error. Please try again.');
            location.reload();
        }
    });
</script>
{% endblock %}